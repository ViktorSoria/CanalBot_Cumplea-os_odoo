<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- List of sets -->
    <template id="portal_my_home_pos_custom" name="Ventas mostrador" customize_show="True" inherit_id="portal.portal_my_home" priority="20">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
            <t t-call="portal.portal_docs_entry">
                <t t-set="title">Ventas en mostrador</t>
                <t t-set="url" t-value="'/my/pos_sales'"/>
                <t t-set="placeholder_count" t-value="'pos_order_count'"/>
            </t>
        </xpath>
    </template>

    <!-- Mini navbar -->
    <template id="portal_my_home_menu_pos_sale" name="Portal layout : pos sales menu entries" inherit_id="portal.portal_breadcrumbs" priority="20">
        <xpath expr="//ol[hasclass('o_portal_submenu')]" position="inside">
            <li t-if="page_name == 'pos_orders'" t-attf-class="breadcrumb-item #{'active ' if not porder else ''}">
                <t t-if="porders">Ventas en mostrador</t>
            </li>
            <li t-if="page_name == 'pos_order'" t-attf-class="breadcrumb-item #{'active ' if not porder else ''}">
                <a t-if="porder" t-attf-href="/my/pos_sales?{{ keep_query() }}">Ventas en mostrador</a>
            </li>
            <li t-if="porder" class="breadcrumb-item active">
                venta-<t t-esc="porder.name"/>
            </li>
        </xpath>
    </template>

    <!-- Order Set -->
    <template id="portal_my_pos_orders" name="My Pos Sales Orders">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>

            <t t-call="portal.portal_searchbar">
                <t t-set="title">Ventas en mostrador</t>
            </t>
            <t t-if="not porders">
                <p>Actualmente no tienes ventas en mostrador.</p>
            </t>
            <t t-if="porders" t-call="portal.portal_table">
                <thead>
                    <tr class="active">
                        <th>
                            <span class='d-none d-md-inline'>Pedido #</span>
                            <span class='d-block d-md-none'>Ref.</span>
                        </th>
                        <th class="text-right">Fecha de compra</th>
                        <th class="text-center"/>
                        <th class="text-right">Total</th>
                    </tr>
                </thead>
                <t t-foreach="porders" t-as="order">
                    <tr>
                        <td>
                            <a t-att-href="order.get_portal_url()">
                                <t t-esc="order.name"/>
                            </a>
                        </td>
                        <td class="text-right">
                            <span t-field="order.date_order" t-options="{'widget': 'date'}"/>&amp;nbsp;
                            <span class='d-none d-md-inline' t-field="order.date_order" t-options="{'time_only': True}"/>
                        </td>
                        <td class="text-center">
                            <span t-if="order.state == 'paid'"  class="badge badge-pill badge-success">
                                <i class="fa fa-fw fa-check" role="img" aria-label="Done" title="Done"/>Pagado
                            </span>
                            <span t-if="order.state == 'invoiced'"  class="badge badge-pill badge-success">
                                <i class="fa fa-fw fa-check" role="img" aria-label="invo" title="Facturado"/>Facturado
                            </span>
                        </td>
                        <td class="text-right"><span t-field="order.amount_total"/></td>
                    </tr>
                </t>
            </t>
        </t>
    </template>

    <!-- Order -->
    <template id="pos_portal_order_content" name="Portal pos order">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            <t t-call="portal.portal_searchbar">
                <t t-set="title">Hola</t>
            </t>
            <div id="introduction" t-attf-class="pb-2 pt-3 card-header bg-white">
              <h2 class="my-0">
                    <em t-esc="porder.name"/>
                </h2>
            </div>
            <div id="quote_content" class="col-12 col-lg justify-content-end">
                <div t-attf-class="card-body">
                    <!-- Informations -->
                    <div id="informations">
                        <div class="row" id="so_date">
                            <div class="mb-3 col-6">
                              <t t-if="porder.state in ['paid', 'done', 'cancel', 'invoiced']">
                                <strong>Fecha de pedido:</strong>
                              </t>
                              <t t-else="">
                                 <strong>Fecha de cotización:</strong>
                              </t>
                              <span t-field="porder.date_order" t-options='{"widget": "date"}'/>
                            </div>

                        </div>
                        <div class="row">
                            <div class="col-lg-6">
                                <strong t-if="porder.partner_id" class="d-block mb-1">Dirección de cliente:</strong>
                                <address t-field="porder.partner_id" t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": True}'/>
                            </div>
                        </div>
                    </div>

                    <section id="details" style="page-break-inside: auto;" class="mt32">
    <!--                    <t t-set="display_discount" t-value="True in [line.discount > 0 for line in sale_order.order_line]"/>-->
                        <table t-att-data-order-id="porder.id" t-att-data-token="porder.token_portal" class="table table-sm table-striped" id="pos_order_table">
                            <thead class="bg-100">
                                <tr>
                                    <th class="text-left">Producto</th>
                                    <th class="text-right">Cantidad</th>
                                    <th t-attf-class="text-right d-none d-sm-table-cell">Precio unitario</th>
                                    <th t-if="display_discount" t-attf-class="text-right d-none d-sm-table-cell">
                                        <span>Desc.%</span>
                                    </th>
                                    <th t-attf-class="text-right d-none d-md-table-cell">
                                        <span>Impuestos</span>
                                    </th>
                                    <th class="text-right" >
                                        <span>Subtotal</span>
    <!--                                    <span groups="account.group_show_line_subtotals_tax_included">Total Price</span>-->
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="sale_tbody">

                                <t t-set="current_subtotal" t-value="0"/>

                                <t t-foreach="porder.lines" t-as="line">

                                    <t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal"/>
    <!--                                <t t-set="current_subtotal" t-value="current_subtotal + line.price_total" groups="account.group_show_line_subtotals_tax_included"/>-->

    <!--                                <tr t-att-class="'bg-200 font-weight-bold o_line_section' if line.display_type == 'line_section' else 'font-italic o_line_note' if line.display_type == 'line_note' else ''">-->
                                    <tr class="bg-200 font-weight-bold o_line_section">
    <!--                                    <t t-if="not line.display_type">-->
                                        <td id="product_name"><span t-field="line.product_id.name"/></td>
                                        <td class="text-right">
                                            <div id="quote_qty">
                                                <span t-field="line.qty"/>
                                                <span t-field="line.product_uom_id.name"/>
                                            </div>
                                        </td>
                                        <td t-attf-class="text-right d-none d-sm-table-cell">
                                            <div
                                                t-if="line.discount &gt;= 0"
                                                t-field="line.price_unit"
                                                t-att-style="line.discount and 'text-decoration: line-through' or None"
                                                t-att-class="(line.discount and 'text-danger' or '') + ' text-right'"
                                            />
                                            <div t-if="line.discount">
                                                <t t-esc="(1-line.discount / 100.0) * line.price_unit" t-options='{"widget": "float", "decimal_precision": "Product Price"}'/>
                                            </div>
                                        </td>
                                        <td t-if="display_discount" t-attf-class="text-right d-none d-sm-table-cell">
                                            <strong t-if="line.discount &gt; 0" class="text-info">
                                                <t t-esc="((line.discount % 1) and '%s' or '%d') % line.discount"/>%
                                            </strong>
                                        </td>
                                        <td t-attf-class="text-right d-none d-md-table-cell">
                                            <span t-esc="', '.join(map(lambda x: (x.description or x.name), line.tax_ids))"/>
                                        </td>
                                        <td class="text-right">
                                            <span t-field="line.price_subtotal"/>
                                        </td>

                                    </tr>

                                    <t t-if="current_section and (line_last or porder.lines[line_index+1].display_type == 'line_section')">
                                        <tr class="is-subtotal text-right">
                                            <td colspan="99">
                                                <strong class="mr16">Subtotal</strong>
                                                <span
                                                    t-esc="current_subtotal"
                                                    t-options='{"widget": "monetary", "display_currency": porder.pricelist_id.currency_id}'
                                                />
                                            </td>
                                        </tr>
                                    </t>
                                </t>
                            </tbody>
                        </table>
                        <div id="total" class="row" name="total" style="page-break-inside: avoid;">
                            <div t-attf-class="#{'col-4' if report_type != 'html' else 'col-sm-7 col-md-5'} ml-auto">
                                <table class="table table-sm">
                                    <tr class="border-black">
                                        <td><strong>Subtotal</strong></td>
                                        <td class="text-right">
                                            <span
                                                data-id="total_untaxed"
                                                t-esc="porder.get_total_untaxed()"
                                                t-options='{"widget": "monetary","display_currency": porder.pricelist_id.currency_id}'
                                            />
                                        </td>
                                    </tr>
                                    <!-- Taxes -->
                                    <t t-foreach="porder.get_amount_by_group()" t-as="amount_by_group">
                                        <tr>
                                            <t t-if="amount_by_group[3] == 1 and porder.get_total_untaxed() == amount_by_group[2]">
                                                <td>
                                                    <span t-esc="amount_by_group[0]"/>
                                                    <span>&amp;nbsp;<span>on</span>&amp;nbsp;<t t-esc="amount_by_group[2]" t-options='{"widget": "monetary", "display_currency": porder.pricelist_id.currency_id}'/></span>
                                                </td>
                                                <td class="text-right">
                                                    <span t-esc="amount_by_group[1]"
                                                        t-options='{"widget": "monetary", "display_currency": porder.pricelist_id.currency_id}'/>
                                                </td>
                                            </t>
                                            <t t-else ="">
                                                <td>
                                                    <span t-esc="amount_by_group[0]"/>
                                                </td>
                                                <td class="text-right">
                                                    <span t-esc="amount_by_group[1]"
                                                        t-options='{"widget": "monetary", "display_currency": porder.pricelist_id.currency_id}'/>
                                                </td>
                                            </t>
                                        </tr>
                                    </t>
                                    <tr class="border-black">
                                        <td><strong>Total</strong></td>
                                        <td class="text-right">
                                            <span data-id="total_amount" t-field="porder.amount_total" t-options='{"widget": "monetary", "display_currency": porder.pricelist_id.currency_id}'/>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </section>
                </div>
            </div>

            <!--
            <t t-call="portal.portal_table">
                <br/>
                <style>
                    .bg_white{
                        background-color: white;
                        margin: 0px;
                    }
                    .bb{
                        border-bottom: 1px solid #ccc;
                    }
                    .pt10{
                        padding-top: 10px;
                    }
                </style>
                <div class="row bg_white bb pt10">
                    <div class="col-6">
                        <h2><t t-esc="porder.name"/></h2>
                    </div>
                </div>
                <div class="card-body">
                    <t t-call="portal.portal_table">
                        <thead>
                            <tr class="active">
                                <th>
                                    <span class='d-none d-md-inline'>Producto</span>
                                    <span class='d-block d-md-none'>Prod.</span>
                                </th>
                                <th class="text-right">Cantidad</th>
                                <th class="text-right">
                                    <span class='d-none d-md-inline'>Unidad de medida</span>
                                    <span class='d-block d-md-none'>UDM</span>
                                </th>
                                <th class="text-right">Precio unitario</th>
                                <th class="text-right">Subtotal</th>
                            </tr>
                        </thead>
                        <t t-foreach="porder.lines" t-as="line">
                            <tr>
                                <td>
                                    <t t-esc="line.full_product_name"/>
                                </td>
                                <td class="text-right">
                                    <span t-field="line.qty"/>
                                </td>
                                <td class="text-right"><span t-field="line.product_uom_id.name"/></td>
                                <td class="text-right"><span t-field="line.price_unit"/></td>
                                <td class="text-right"><span t-field="line.price_subtotal_incl"/></td>
                            </tr>
                        </t>
                    </t>
                    <div class="row" style="text-align: right; padding-right:20px;">
                        <div class="col-9"/>
                        <div class="col-3" style="border-top: 2px solid grey;">
                            <h3>Total: </h3><span t-field="porder.amount_total"/>
                        </div>
                    </div>
                </div>
            </t>-->
        </t>
    </template>

<!--    modificacion facturas-->
    <template id="portal_my_invoices" inherit_id="account.portal_my_invoices" name="Invoice">
        <xpath expr="//thead/tr/th[@class='text-right']" position="before">
            <th>Timbrada</th>
            <th class="text-right">Total</th>
            <t t-set="total" t-value="0"/>
            <t t-set="total_pendiente" t-value="0"/>
        </xpath>
        <xpath expr="//tbody/t/tr/td[@class='text-right']" position="before">
            <th>
                <i class="fa fa-fw fa-check" t-if="invoice.l10n_mx_edi_cfdi_uuid"/>
                <i class="fa fa-fw fa-remove" t-if="not invoice.l10n_mx_edi_cfdi_uuid"/>
            </th>
            <td class="text-right"><span t-esc="-invoice.amount_total if invoice.move_type == 'out_refund' else invoice.amount_total" t-options='{"widget": "monetary", "display_currency": invoice.currency_id}'/></td>
            <t t-set="total" t-value="total + (-invoice.amount_total if invoice.move_type == 'out_refund' else invoice.amount_total)"/>
            <t t-set="total_pendiente" t-value="total_pendiente + (-invoice.amount_residual if invoice.move_type == 'out_refund' else invoice.amount_residual)"/>
        </xpath>
        <xpath expr="//tbody/t" position="after">
            <tr t-if="invoices">
                <td/>
                <td/>
                <td/>
                <td/>
                <td>Totales:</td>
                <td class="text-right"><span t-esc="total" t-options='{"widget": "monetary", "display_currency": invoices[0].currency_id}'/></td>
                <td class="text-right"><span t-esc="total_pendiente" t-options='{"widget": "monetary", "display_currency": invoices[0].currency_id}'/></td>
            </tr>
        </xpath>
    </template>
</odoo>